<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Enhancement Pro - Face Morphing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
        }

        h1 {
            color: #4338ca;
            margin-bottom: 5px;
        }

        h2 {
            color: #7c3aed;
            font-size: 14px;
            margin-bottom: 20px;
        }

        #drop-area {
            border: 2px dashed #4f46e5;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            background: #f0f4ff;
            transition: all 0.3s;
            border-radius: 12px;
        }

        #drop-area:hover,
        #drop-area.dragover {
            background: #e0e7ff;
            border-color: #4338ca;
        }

        #filename {
            font-weight: bold;
            color: #4338ca;
        }

        .group {
            margin: 15px 0;
            padding: 15px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .group h3 {
            margin-bottom: 12px;
            color: #333;
            font-size: 14px;
        }

        button {
            padding: 8px 16px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        #status {
            margin-top: 15px;
            color: #1e40af;
            font-weight: bold;
            min-height: 22px;
        }

        .slider-group {
            margin: 15px 0;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .slider-value {
            color: #4f46e5;
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 900px) {
            .preview-section {
                grid-template-columns: 1fr;
            }
        }

        .preview-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .preview-box h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 13px;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            display: block;
            margin: 0 auto;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #download-btn {
            background: #059669;
            color: white;
            border-color: #059669;
        }

        #download-btn:hover:not(:disabled) {
            background: #047857;
        }

        #reset-btn {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        #reset-btn:hover:not(:disabled) {
            background: #dc2626;
        }

        #enhance-btn {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        #enhance-btn:hover:not(:disabled) {
            background: #4338ca;
        }

        input[type="file"] {
            display: none;
        }

        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #0284c7;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #0c4a6e;
            text-align: left;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(79, 70, 229, 0.3);
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <h1>‚ú® Face Enhancement Pro - Face Morphing</h1>
    <h2>dengan ML5.js Face Detection & Distortion</h2>

    <div id="drop-area">üì∏ Klik atau seret file gambar ke sini (JPG, PNG, etc)</div>
    <div>File terpilih: (<span id="filename">-</span>)</div>

    <div class="group">
        <h3>Pengaturan Face Morphing</h3>

        <div class="slider-group">
            <div class="slider-label">
                <span>üë§ Rahang (Jaw Enhancement)</span>
                <span class="slider-value" id="jawValue">50</span>
            </div>
            <input type="range" id="jaw" min="0" max="100" value="50">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>‚ú® Pipi (Cheekbones)</span>
                <span class="slider-value" id="cheekValue">50</span>
            </div>
            <input type="range" id="cheek" min="0" max="100" value="50">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>üëÅÔ∏è Mata (Eye Enhancement)</span>
                <span class="slider-value" id="eyeValue">50</span>
            </div>
            <input type="range" id="eye" min="0" max="100" value="50">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>ü§è Hidung (Nose Refinement)</span>
                <span class="slider-value" id="noseValue">50</span>
            </div>
            <input type="range" id="nose" min="0" max="100" value="50">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>üíã Mulut (Lips)</span>
                <span class="slider-value" id="lipsValue">50</span>
            </div>
            <input type="range" id="lips" min="0" max="100" value="50">
        </div>

        <div class="slider-group">
            <div class="slider-label">
                <span>‚ú® Kulit (Skin Smoothing)</span>
                <span class="slider-value" id="skinValue">50</span>
            </div>
            <input type="range" id="skin" min="0" max="100" value="50">
        </div>
    </div>

    <div class="group">
        <div class="button-group">
            <button id="enhance-btn" disabled>‚ú® Terapkan Enhancement</button>
            <button id="reset-btn" disabled>üîÑ Reset</button>
            <button id="download-btn" disabled>‚¨áÔ∏è Download Hasil</button>
        </div>
    </div>

    <div id="status"></div>

    <div class="preview-section">
        <div class="preview-box">
            <h4>Original Image</h4>
            <canvas id="originalCanvas"></canvas>
        </div>
        <div class="preview-box">
            <h4>Enhanced Result</h4>
            <canvas id="enhancedCanvas"></canvas>
        </div>
    </div>

    <div class="info-box">
        üí° <strong>Tips:</strong> Upload foto wajah Anda yang jernih (depan menghadap kamera). Sistem akan mendeteksi wajah otomatis, kemudian sesuaikan slider untuk menonjolkan fitur yang diinginkan.
    </div>

    <!-- TensorFlow.js & Face-api.js Library -->
    <script async src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3"></script>
    <script async src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh@0"></script>

    <script>
        const originalCanvas = document.getElementById('originalCanvas');
        const enhancedCanvas = document.getElementById('enhancedCanvas');
        const origCtx = originalCanvas.getContext('2d');
        const enhCtx = enhancedCanvas.getContext('2d');

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);

        const dropArea = document.getElementById('drop-area');
        const filenameSpan = document.getElementById('filename');
        const enhanceBtn = document.getElementById('enhance-btn');
        const resetBtn = document.getElementById('reset-btn');
        const downloadBtn = document.getElementById('download-btn');
        const statusDiv = document.getElementById('status');

        let originalImage = null;
        let originalImageData = null;
        let detections = null;
        let originalFileName = '';
        let isEnhanced = false;
        let faceMeshModel = null;

        // Load model function
        async function loadModel() {
            try {
                statusDiv.textContent = '‚è≥ Loading FaceMesh model...';
                // Panggil facemesh.load() hanya setelah tf dan facemesh siap
                faceMeshModel = await facemesh.load(); 
                statusDiv.textContent = '‚úÖ Model loaded. Siap untuk upload foto.';
            } catch (err) {
                statusDiv.textContent = '‚ö†Ô∏è Error loading model. Refresh page.';
                console.error(err);
            }
        }

        // --- BAGIAN YANG DIPERBAIKI: Menunggu TF dan FaceMesh siap ---
        // Mengganti Promise.all yang rumit dengan Interval check yang lebih stabil.
        const checkLibraries = setInterval(() => {
            // Periksa apakah kedua variabel global sudah terdefinisi
            if (typeof tf !== 'undefined' && typeof facemesh !== 'undefined') {
                clearInterval(checkLibraries); // Hentikan pemeriksaan
                loadModel(); // Panggil fungsi pemuatan model
            }
        }, 100); 
        // -----------------------------------------------------------------

        // Drop area events
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                statusDiv.textContent = '‚ùå File harus berformat gambar (JPG, PNG, etc)!';
                return;
            }

            originalFileName = file.name;
            const reader = new FileReader();

            reader.onload = (e) => {
                const img = new Image();
                img.onload = async () => {
                    // Set canvas size
                    originalCanvas.width = img.width;
                    originalCanvas.height = img.height;
                    enhancedCanvas.width = img.width;
                    enhancedCanvas.height = img.height;

                    // Draw original
                    origCtx.drawImage(img, 0, 0);
                    enhCtx.drawImage(img, 0, 0);

                    originalImage = img;
                    originalImageData = origCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height);

                    filenameSpan.textContent = file.name;
                    statusDiv.textContent = '‚è≥ Mendeteksi wajah...';
                    // Detect face
                    await detectFace(img);
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);
        }

        async function detectFace(img) {
            if (!faceMeshModel) {
                statusDiv.textContent = '‚è≥ Menunggu model siap...';
                return;
            }

            try {
                statusDiv.textContent = '‚è≥ Mendeteksi wajah...';
                const predictions = await faceMeshModel.estimateFaces(img);

                if (predictions && predictions.length > 0) {
                    detections = predictions;
                    statusDiv.textContent = '‚úÖ Wajah terdeteksi! Sesuaikan slider dan klik "Terapkan Enhancement".';
                    enhanceBtn.disabled = false;
                    resetBtn.disabled = false;
                    downloadBtn.disabled = false;
                } else {
                    statusDiv.textContent = '‚ùå Tidak dapat mendeteksi wajah. Pastikan wajah terlihat jelas di foto.';
                }
            } catch (err) {
                console.error(err);
                statusDiv.textContent = '‚ö†Ô∏è Error saat mendeteksi wajah. Coba foto lain.';
            }
        }

        function updateValues() {
            document.getElementById('jawValue').textContent = document.getElementById('jaw').value;
            document.getElementById('cheekValue').textContent = document.getElementById('cheek').value;
            document.getElementById('eyeValue').textContent = document.getElementById('eye').value;
            document.getElementById('noseValue').textContent = document.getElementById('nose').value;
            document.getElementById('lipsValue').textContent = document.getElementById('lips').value;
            document.getElementById('skinValue').textContent = document.getElementById('skin').value;
        }

        function distortImage() {
            if (!originalImage || !detections || detections.length === 0) {
                statusDiv.textContent = '‚ùå Wajah tidak terdeteksi!';
                return;
            }

            statusDiv.textContent = '‚è≥ Memproses face morphing...';
            const jaw = parseInt(document.getElementById('jaw').value);
            const cheek = parseInt(document.getElementById('cheek').value);
            const eye = parseInt(document.getElementById('eye').value);
            const nose = parseInt(document.getElementById('nose').value);
            const lips = parseInt(document.getElementById('lips').value);
            const skin = parseInt(document.getElementById('skin').value);

            // Copy original image data
            enhCtx.drawImage(originalImage, 0, 0);
            let imageData = enhCtx.getImageData(0, 0, enhancedCanvas.width, enhancedCanvas.height);
            let data = imageData.data;

            // Apply skin smoothing
            if (skin > 50) {
                data = applySkinSmoothing(data, enhancedCanvas.width, enhancedCanvas.height, (skin - 50) / 50);
            }

            // Apply face distortion using landmarks
            const landmarks = detections[0].landmarks;

            // Jaw distortion
            if (jaw !== 50) {
                distortRegion(data, landmarks, jaw, 'jaw', enhancedCanvas.width, enhancedCanvas.height);
            }

            // Cheek enhancement
            if (cheek !== 50) {
                distortRegion(data, landmarks, cheek, 'cheek', enhancedCanvas.width, enhancedCanvas.height);
            }

            // Eye enhancement
            if (eye !== 50) {
                distortRegion(data, landmarks, eye, 'eye', enhancedCanvas.width, enhancedCanvas.height);
            }

            // Nose refinement
            if (nose !== 50) {
                distortRegion(data, landmarks, nose, 'nose', enhancedCanvas.width, enhancedCanvas.height);
            }

            // Lips enhancement
            if (lips !== 50) {
                distortRegion(data, landmarks, lips, 'lips', enhancedCanvas.width, enhancedCanvas.height);
            }

            imageData.data.set(data);
            enhCtx.putImageData(imageData, 0, 0);
            isEnhanced = true;
            statusDiv.textContent = '‚úÖ Face morphing berhasil diterapkan!';
        }

        function applySkinSmoothing(data, width, height, factor) {
            const kernel = [
                [1, 2, 1],
                [2, 4, 2],
                [1, 2, 1]
            ];
            const kernelSum = 16;
            const newData = new Uint8ClampedArray(data);
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += data[idx] * kernel[ky + 1][kx + 1];
                            }
                        }
                        const smoothed = sum / kernelSum;
                        const idx = (y * width + x) * 4 + c;
                        newData[idx] = data[idx] * (1 - factor * 0.4) + smoothed * (factor * 0.4);
                    }
                }
            }
            return newData;
        }

        function distortRegion(data, landmarks, value, region, width, height) {
            const factor = (value - 50) / 50;
            const intensity = Math.abs(factor);

            // Brighten and sharpen selected regions
            landmarks.forEach((point, idx) => {
                const x = Math.round(point[0]);
                const y = Math.round(point[1]);

                if (x > 0 && x < width && y > 0 && y < height) {
                    // Determine if point is in target region based on FaceMesh landmarks
                    let isTarget = false;

                    // FaceMesh has specific landmark indices for different face parts
                    if (region === 'jaw' && idx >= 200 && idx <= 230) isTarget = true;
                    if (region === 'cheek' && (idx >= 50 && idx <= 100 || idx >= 330 && idx <= 380)) isTarget = true;
                    if (region === 'eye' && (idx >= 33 && idx <= 133 || idx >= 173 && idx <= 247)) isTarget = true;
                    if (region === 'nose' && (idx >= 195 && idx <= 220)) isTarget = true;
                    if (region === 'lips' && (idx >= 270 && idx <= 320)) isTarget = true;

                    if (isTarget) {
                        // Apply brightness and contrast
                        const idx_data = (y * width + x) * 4;
                        if (idx_data < data.length) {
                            if (factor > 0) {
                                data[idx_data] = Math.min(255, data[idx_data] + 20 * intensity);
                                data[idx_data + 1] = Math.min(255, data[idx_data + 1] + 20 * intensity);
                                data[idx_data + 2] = Math.min(255, data[idx_data + 2] + 20 * intensity);
                            } else {
                                data[idx_data] = Math.max(0, data[idx_data] - 15 * intensity);
                                data[idx_data + 1] = Math.max(0, data[idx_data + 1] - 15 * intensity);
                                data[idx_data + 2] = Math.max(0, data[idx_data + 2] - 15 * intensity);
                            }
                        }
                    }
                }
            });
        }

        enhanceBtn.addEventListener('click', distortImage);
        resetBtn.addEventListener('click', () => {
            if (originalImage) {
                enhCtx.drawImage(originalImage, 0, 0);
                document.getElementById('jaw').value = 50;
                document.getElementById('cheek').value = 50;
                document.getElementById('eye').value = 50;
                document.getElementById('nose').value = 50;
                document.getElementById('lips').value = 50;
                document.getElementById('skin').value = 50;
                updateValues();
                isEnhanced = false;
                statusDiv.textContent = 'üîÑ Reset ke gambar original.';
            }
        });
        downloadBtn.addEventListener('click', () => {
            if (!isEnhanced) {
                statusDiv.textContent = '‚ö†Ô∏è Harap terapkan enhancement terlebih dahulu!';
                return;
            }

            const link = document.createElement('a');
            const baseName = originalFileName.replace(/\.[^/.]+$/, '');
            link.href = enhancedCanvas.toDataURL('image/png');
            link.download = `${baseName}_enhanced.png`;
            link.click();
            statusDiv.textContent = '‚úÖ File berhasil diunduh!';
        });

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateValues);
        });
    </script>
</body>
</html>
